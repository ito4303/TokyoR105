---
title: "Rã¨Stanã§å¾®åˆ†æ–¹ç¨‹å¼å…¥ã‚Šã®ãƒ¢ãƒ‡ãƒ«"
subtitle: "Tokyo.R #105"
author: "ä¼Šæ±å®æ¨¹"
format:
  revealjs:
    theme: [default, custom.scss]
    standalone: true
lang: ja
date: 2023-04-22
date-format: iso
editor: visual
---

## è‡ªå·±ç´¹ä»‹

::: columns
::: {.column width="50%"}
-   åå‰: ä¼Šæ±å®æ¨¹
-   å‹¤å‹™å…ˆ: æ£®æ—ç·åˆç ”ç©¶æ‰€\
    åŒ—æµ·é“æ”¯æ‰€
-   å°‚é–€: æ£®æ—ç”Ÿæ…‹å­¦
-   ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ
    -   <https://ito4303.sakura.ne.jp/>
    -   <https://ito4303.github.io/>
:::

::: {.column width="50%"}
-   å…±è¨³æ›¸:\
    [![](https://www.hanmoto.com/bd/img/9784320057807.jpg){fig-alt="BUGSã§å­¦ã¶éšå±¤ãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€" style="vertical-align: top;"}](https://www.hanmoto.com/bd/isbn/9784320057807) [![](https://www.hanmoto.com/bd/img/9784320058149.jpg){fig-alt="ç”Ÿæ…‹å­¦ã®ãŸã‚ã®éšå±¤ãƒ¢ãƒ‡ãƒªãƒ³ã‚°" style="vertical-align: top;"}](https://www.hanmoto.com/bd/isbn/9784320058149)
:::
:::

## ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ–¹ç¨‹å¼

ã‚ã‚‹ç”Ÿç‰©ã®å€‹ä½“æ•° *x* (å®Ÿæ•°)ã®ã€æ™‚é–“ *t* ã«ãŠã‘ã‚‹å¤‰åŒ–é‡

$$
\frac{dx}{dt} = rx\left(1-\frac{x}{K}\right)
$$

-   *r* : å†…çš„è‡ªç„¶å¢—åŠ ç‡
-   *K* : ç’°å¢ƒåå®¹åŠ›

## æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ

```{r settings}
library(ggplot2)
library(cmdstanr)

logistic <- function(t, x0, r, K) {
  K / (1 + (K / x0 - 1) * exp(-r * t))
}

# settings
r <- 0.4           # å†…çš„è‡ªç„¶å¢—åŠ ç‡
K <- 10            # ç’°å¢ƒåå®¹åŠ›
Time <- seq(0, 30) # æ™‚é–“
N <- length(Time)  # æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã®æ•°
x0 <- 0.05         # å€‹ä½“æ•°é‡ã®åˆæœŸå€¤

# generate data
x <- sapply(Time, logistic, x0 = x0, r = r, K = K)

# plot
p0 <- data.frame(Time = Time, Abundance = x) |>
  ggplot(aes(x = Time, y = Abundance)) +
  geom_point() +
  geom_function(fun = logistic,
                args = list(x0 = x0, r = r, K = K)) +
  ylim(0, 15)

# add noise
set.seed(1234)
sigma <- 0.15
y <- rlnorm(N, log(x), sigma)

# plot
p1 <- data.frame(Time = Time, Abundance = y) |>
  ggplot(mapping = aes(x = Time, y = Abundance)) +
  geom_point() +
  geom_function(fun = logistic,
                args = list(x0 = x0, r = r, K = K)) +
  ylim(0, 15)
print(p1)
```

::: {style="font-size: 80%;"}
-   ç”¨æ„ã—ãŸãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ›²ç·šã«ãã£ãŸå€¤ã«ã€å¯¾æ•°æ­£è¦åˆ†å¸ƒã®ãƒã‚¤ã‚ºãŒåŠ ã‚ã£ã¦ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚ŒãŸã¨ã™ã‚‹ã€‚
-   å¾®åˆ†æ–¹ç¨‹å¼ã‚’çµ„ã¿è¾¼ã‚“ã ãƒ¢ãƒ‡ãƒ«ã§ã€ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€æ›²ç·šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (*r*, *K*) ã‚’æ¨å®šã™ã‚‹ã€‚
:::

## Stanã®å¸¸å¾®åˆ†æ–¹ç¨‹å¼ã‚½ãƒ«ãƒãƒ¼é–¢æ•°

ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç•°ãªã‚‹ç¨®é¡ãŒã„ãã¤ã‹ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŒã€ä»Šå›ã¯`ode_rk45`ã‚’ä½¿ç”¨ã€‚

``` {style="margin-top: 1em; margin-bottom: 2em; border: 1px solid gray;"}
array[] vector ode_rk45(function ode, vector initial_state, real initial_time, array[] real times, ...)
```

å¼•æ•°ã¨ã—ã¦ä¸ãˆã‚‹é–¢æ•°ã®å½¢å¼

``` {style="border: 1px solid gray;"}
vector ode(real time, vector state, ...)
```

## Stanãƒ¢ãƒ‡ãƒ«ã®functionsãƒ–ãƒ­ãƒƒã‚¯

ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ–¹ç¨‹å¼ã‚’å®šç¾©

```{r stan_code_functions}
model_file <- "logistic.stan"
stan_code <- readLines(model_file)
#cat(stan_code[10:19], sep = "\n")
```

``` {.stan style="font-size: 85%;"}
functions {
  vector logistic(real t, vector x, array[] real theta) {
    vector[1] dx_dt;
    real r = theta[1];
    real K = theta[2];

    dx_dt[1] = r * x[1] * (1 - x[1] / K);
    return dx_dt;
  }
}
```

## Stanãƒ¢ãƒ‡ãƒ«ã®modelãƒ–ãƒ­ãƒƒã‚¯

```{r stan_code_model}
#cat(stan_code[35:47], sep = "\n")
```

``` {.stan style="font-size: 85%;"}
model {
  array[2] real theta = {r, K};
  array[N] vector[1] z = ode_rk45(logistic, z0, 0, ts, theta);

  y0 ~ lognormal(log(z0), sigma);
  for (n in 1:N)
    y[n] ~ lognormal(log(z[n]), sigma);
  // priors
  r ~ normal(0, 5);
  K ~ normal(0, 100);
  z0 ~ normal(0, 100);
  sigma ~ normal(0, 5);
}
```

```{r stan_fit}
#| include: false
#| cache: true
output_dir <- "stan_output"
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}

# fit using Stan
stan_data <- list(N = N - 1,
                  ts = Time[-1],
                  y0 = y[1],
                  y = y[-1])
model <- cmdstan_model(model_file)
fit <- model$sample(stan_data, output_dir = output_dir)
```

## çµæœ

::: {style="font-size: 80%;"}
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®äº‹å¾Œå¹³å‡å€¤ã‚’ã¤ã‹ã£ã¦ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ›²ç·šã‚’æç”»(èµ¤ç·š)ã€‚
:::

```{r results}
# posterior mean
x0_hat <- fit$summary("z0")$mean
r_hat <- fit$summary("r")$mean
K_hat <- fit$summary("K")$mean

p1 +
  geom_function(fun = logistic,
                args = list(x0 = x0_hat, r = r_hat, K = K_hat),
                color = "red", linewidth = 1.5, alpha = 0.8)
```

## æœ¬æ—¥ã®è³‡æ–™

-   slide:
-   repo: <https://github.com/ito4303/TokyoR105>

::: {style="text-align: center; font-size: 300%;"}
ğŸ¥³
:::
